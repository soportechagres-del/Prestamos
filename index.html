<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PuntoCrédito Pro v5 - Gestión Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .animate-fade { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-btn-active { background-color: #059669 !important; color: white !important; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.2); }

        /* ESTILOS DEL NUEVO LOGO */
        .logo-container { display: flex; align-items: center; }
        .logo-text { margin-left: 12px; line-height: 1.2; }
        .logo-title { font-size: 20px; font-weight: bold; color: #ffffff; }
        .logo-title span { color: #10b981; }
        .logo-slogan { font-size: 10px; color: #f59e0b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* LOGIN OVERLAY */
        #login-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="login-overlay">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center">
            <div class="flex justify-center mb-4">
                <svg width="60" height="60" viewBox="0 0 100 100">
                    <path d="M50 5 C30 5 15 20 15 40 C15 65 50 95 50 95 C50 95 85 65 85 40 C85 20 70 5 50 5Z" fill="#16a34a"/>
                    <text x="50" y="55" text-anchor="middle" font-size="30" font-weight="bold" fill="white">$</text>
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-6">Iniciar Sesión</h2>
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Usuario</label>
                    <input type="text" id="user_login" class="w-full bg-slate-50 p-3 rounded-xl border outline-none" placeholder="admin">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Contraseña</label>
                    <input type="password" id="pass_login" class="w-full bg-slate-50 p-3 rounded-xl border outline-none" placeholder="****">
                </div>
                <button onclick="checkLogin()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg">Entrar</button>
            </div>
        </div>
    </div>

    <div class="flex min-h-screen">
        <aside class="w-64 bg-slate-900 text-white flex flex-col fixed h-full z-40">
            <div class="p-6 border-b border-slate-800">
                <div class="logo-container">
                    <svg width="40" height="40" viewBox="0 0 100 100">
                        <path d="M50 5 C30 5 15 20 15 40 C15 65 50 95 50 95 C50 95 85 65 85 40 C85 20 70 5 50 5Z" fill="#16a34a"/>
                        <circle cx="50" cy="40" r="22" fill="#dcfce7"/>
                        <text x="50" y="47" text-anchor="middle" font-size="26" font-weight="bold" fill="#15803d">$</text>
                        <path d="M35 55 L55 35 L55 42 L68 42 L68 30 L85 45 L68 60 L68 48 L55 48 L55 55 Z" fill="#f59e0b"/>
                    </svg>
                    <div class="logo-text">
                        <div class="logo-title">Punto <span>Crédito</span></div>
                        <div class="logo-slogan">Solvencia</div>
                    </div>
                </div>
            </div>

            <div class="mx-4 mt-6 p-4 bg-slate-800/50 border border-slate-700 rounded-2xl">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Balance Total del Sistema</p>
                <p id="sidebarTotal" class="text-xl font-bold text-emerald-400 leading-none mt-1">$0.00</p>
                <p class="text-[9px] text-slate-500 mt-2 font-medium">(Capital + Ganancias)</p>
            </div>
            
            <nav class="flex-grow p-4 space-y-2 mt-4" id="mainNav">
                <button data-section="dashboard" onclick="showSection('dashboard', this)" class="nav-btn nav-btn-active w-full flex items-center p-3 rounded-xl transition-all"><i class="fas fa-home mr-3"></i> Dashboard</button>
                <button data-section="clients" onclick="showSection('clients', this)" class="nav-btn w-full flex items-center p-3 rounded-xl text-slate-400 transition-all hover:bg-slate-800 hover:text-emerald-400"><i class="fas fa-users mr-3"></i> Base de Clientes</button>
                <button data-section="investors" onclick="showSection('investors', this)" class="nav-btn w-full flex items-center p-3 rounded-xl text-slate-400 transition-all hover:bg-slate-800 hover:text-emerald-400"><i class="fas fa-hand-holding-heart mr-3"></i> Aportantes</button>
                <button data-section="config" onclick="showSection('config', this)" class="nav-btn w-full flex items-center p-3 rounded-xl text-slate-400 transition-all hover:bg-slate-800 hover:text-emerald-400"><i class="fas fa-cog mr-3"></i> Configuración</button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full text-slate-500 text-xs hover:text-white transition-colors">Cerrar Sesión</button>
            </div>
        </aside>

        <main class="flex-grow ml-64 p-10">
            <section id="section-dashboard" class="content-section animate-fade">
                <header class="flex justify-between items-center mb-10">
                    <div><h1 class="text-3xl font-extrabold text-slate-800">Panel Financiero</h1><p class="text-slate-500 text-sm">Resumen de capital y rentabilidad.</p></div>
                        <div class="flex items-center gap-3">
                            <button onclick="openModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all">+ Nuevo Préstamo</button>
                            <button id="profileBtn" onclick="openProfile()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl font-bold text-sm">Mi Cuenta</button>
                        </div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Capital Disponible</p><p id="statAvailable" class="text-xl font-bold text-slate-800">$0.00</p></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Capital Prestado</p><p id="statLent" class="text-xl font-bold text-orange-600">$0.00</p></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative">
                        <div class="flex justify-between items-center mb-1"><p class="text-slate-400 text-[10px] font-bold uppercase">Intereses Cobrados</p><button onclick="resetEarnings()" class="text-slate-300 hover:text-red-500 transition-colors"><i class="fas fa-undo-alt text-[10px]"></i></button></div>
                        <p id="statTotalEarned" class="text-xl font-bold text-emerald-600">$0.00</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-[10px] font-bold uppercase mb-1">Préstamos Activos</p><p id="statActiveCount" class="text-xl font-bold text-indigo-600">0</p></div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b">
                            <tr><th class="p-4 text-xs font-bold text-slate-400 uppercase">Cliente / CIP</th><th class="p-4 text-xs font-bold text-slate-400 uppercase">Capital Pendiente</th><th class="p-4 text-xs font-bold text-slate-400 uppercase text-center">Interés %</th><th class="p-4 text-xs font-bold text-slate-400 uppercase text-right">Interés Ganancia</th><th class="p-4 text-xs font-bold text-slate-400 uppercase text-center">Acciones</th></tr>
                        </thead>
                        <tbody id="loanTableBody" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                </div>
            </section>

            <section id="section-clients" class="content-section hidden animate-fade">
                <header class="mb-10"><h1 class="text-3xl font-extrabold text-slate-800">Base de Clientes</h1></header>
                <div id="clientsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <section id="section-investors" class="content-section hidden animate-fade">
                <header class="flex justify-between items-center mb-10">
                    <div><h1 class="text-3xl font-extrabold text-slate-800">Aportantes</h1><p class="text-slate-500 text-sm">Distribución proporcional.</p></div>
                    <button onclick="openInvestorModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all">+ Registrar Aportante</button>
                </header>
                <div id="investorsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <section id="section-config" class="content-section hidden animate-fade">
                <h1 class="text-2xl font-bold mb-6 text-slate-800">Configuración</h1>
                
                <div class="bg-white p-8 rounded-3xl shadow-sm mb-6 border border-slate-100 max-w-lg">
                    <h2 class="text-sm font-bold text-indigo-600 uppercase mb-4">Gestión de Usuarios</h2>
                    <div class="space-y-3">
                        <div id="user_list_admin" class="divide-y divide-slate-100"></div>
                        <div class="pt-4 space-y-2">
                            <input type="text" id="nu_name" placeholder="Nuevo Usuario" class="w-full bg-slate-50 p-3 rounded-xl border text-sm">
                            <input type="password" id="nu_pass" placeholder="Nueva Contraseña" class="w-full bg-slate-50 p-3 rounded-xl border text-sm">
                            <div class="mt-2">
                                <label class="text-[11px] font-medium text-slate-600">Rol</label>
                                <select id="nu_role" class="w-full bg-slate-50 p-2 rounded-xl border text-sm mt-1">
                                    <option value="user">Usuario</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm mt-2">
                                <label class="flex items-center"><input id="nu_perm_dashboard" type="checkbox" class="mr-2">Dashboard</label>
                                <label class="flex items-center"><input id="nu_perm_clients" type="checkbox" class="mr-2">Clientes</label>
                                <label class="flex items-center"><input id="nu_perm_investors" type="checkbox" class="mr-2">Aportantes</label>
                                <label class="flex items-center"><input id="nu_perm_config" type="checkbox" class="mr-2">Configuración</label>
                            </div>
                            <button onclick="createUser()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm">Crear Usuario</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-3xl shadow-sm max-w-lg border border-slate-100">
                    <button onclick="resetApp()" class="w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-600 hover:text-white transition-all">Reiniciar Sistema</button>
                </div>
            </section>
        </main>
    </div>

    <div id="profileModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-[360px] shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Mi Cuenta</h2>
            <div class="text-sm space-y-2">
                <div><b>Usuario:</b> <span id="profile_user" class="font-medium"></span></div>
                <div><b>Rol:</b> <span id="profile_role" class="font-medium"></span></div>
                <div><b>Contraseña:</b> <span id="profile_pass" class="font-medium"></span></div>
                <div><b>Permisos:</b> <span id="profile_allowed" class="font-medium"></span></div>
            </div>
            <div class="mt-6"><button onclick="closeProfile()" class="w-full py-2 bg-slate-100 rounded-xl font-bold">Cerrar</button></div>
        </div>
    </div>

    <div id="investorModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-3xl w-[400px] shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Nuevo Aportante</h2>
            <div class="space-y-4">
                <input type="text" id="i_name" placeholder="Nombre" class="w-full bg-slate-50 p-3 rounded-xl border outline-none">
                <input type="number" id="i_amount" placeholder="Monto inicial $" class="w-full bg-slate-50 p-3 rounded-xl border outline-none">
                <button onclick="saveInvestor()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">Registrar</button>
                <button onclick="closeInvestorModal()" class="w-full text-slate-400 font-bold text-sm">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="editInvestorModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-3xl w-[400px] shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Modificar Aportante</h2>
            <div class="space-y-4">
                <input type="hidden" id="ei_id">
                <label class="text-xs font-bold text-slate-400 uppercase">Nombre</label>
                <input type="text" id="ei_name" class="w-full bg-slate-50 p-3 rounded-xl border outline-none">
                <label class="text-xs font-bold text-slate-400 uppercase">Capital Base ($)</label>
                <input type="number" id="ei_amount" class="w-full bg-slate-50 p-3 rounded-xl border outline-none">
                <button onclick="updateInvestor()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">Guardar Cambios</button>
                <button onclick="closeEditInvestorModal()" class="w-full text-slate-400 font-bold text-sm">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="loanModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-3xl w-[420px] shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Nuevo Préstamo</h2>
            <div class="space-y-4">
                <select id="m_select_client" onchange="fillClientData()" class="w-full bg-slate-50 p-3 rounded-xl border text-sm font-medium"><option value="">-- Nuevo Cliente --</option></select>
                <input type="text" id="m_name" placeholder="Nombre" class="w-full bg-slate-50 p-3 rounded-xl border">
                <input type="text" id="m_cip" placeholder="CIP" class="w-full bg-slate-50 p-3 rounded-xl border">
                <input type="text" id="m_phone" placeholder="WhatsApp" class="w-full bg-slate-50 p-3 rounded-xl border">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="m_amount" placeholder="Monto $" class="w-full bg-slate-50 p-3 rounded-xl border">
                    <input type="number" id="m_interest" placeholder="Interés %" class="w-full bg-slate-50 p-3 rounded-xl border" value="10">
                </div>
                <button onclick="saveLoan()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold">Confirmar</button>
                <button onclick="closeModal()" class="w-full text-slate-400 font-bold text-sm">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="editClientModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-3xl w-[400px] shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Modificar Cliente</h2>
            <div class="space-y-4">
                <input type="hidden" id="e_old_cip">
                <input type="text" id="e_name" placeholder="Nombre" class="w-full bg-slate-50 p-3 rounded-xl border">
                <input type="text" id="e_cip" placeholder="CIP" class="w-full bg-slate-50 p-3 rounded-xl border">
                <input type="text" id="e_phone" placeholder="WhatsApp" class="w-full bg-slate-50 p-3 rounded-xl border">
                <button onclick="updateClient()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">Guardar Cambios</button>
                <button onclick="closeEditClientModal()" class="w-full text-slate-400 font-bold text-sm">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-3xl w-[600px] max-h-[80vh] overflow-hidden flex flex-col shadow-2xl">
            <h2 class="text-2xl font-bold mb-2 text-slate-800">Historial de Pagos</h2>
            <p id="historyClientName" class="text-indigo-600 font-bold mb-6"></p>
            <div class="overflow-y-auto flex-grow border rounded-xl">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b sticky top-0">
                        <tr>
                            <th class="p-3 font-bold text-slate-400 uppercase text-[10px]">Fecha</th>
                            <th class="p-3 font-bold text-slate-400 uppercase text-[10px]">Abono Total</th>
                            <th class="p-3 font-bold text-slate-400 uppercase text-[10px]">A Capital</th>
                            <th class="p-3 font-bold text-slate-400 uppercase text-[10px]">Interés</th>
                            <th class="p-3 font-bold text-slate-400 uppercase text-[10px]">Saldo Rest.</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y"></tbody>
                </table>
            </div>
            <div class="mt-6 grid grid-cols-2 gap-3">
                <button onclick="downloadHistory()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Descargar Historial</button>
                <button onclick="closeHistoryModal()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Cerrar Historial</button>
            </div>
        </div>
    </div>

    <div id="invoice-container" style="position: absolute; left: -9999px; top: -9999px;">
        <div id="invoice-template" style="width: 800px; padding: 50px; background: white; font-family: 'Segoe UI', Arial, sans-serif; color: #334155;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 30px; margin-bottom: 30px;">
                <div style="display: flex; align-items: center;">
                    <div style="background: #16a34a; padding: 10px; border-radius: 12px; margin-right: 15px;">
                        <svg width="40" height="40" viewBox="0 0 100 100">
                            <path d="M50 5 C30 5 15 20 15 40 C15 65 50 95 50 95 C50 95 85 65 85 40 C85 20 70 5 50 5Z" fill="#ffffff"/>
                            <text x="50" y="55" text-anchor="middle" font-size="35" font-weight="bold" fill="#16a34a">$</text>
                        </svg>
                    </div>
                    <div>
                        <h1 style="margin: 0; color: #1e3a8a; font-size: 28px; font-weight: 800;">Punto <span style="color: #16a34a;">Crédito</span></h1>
                        <p style="margin: 0; color: #f59e0b; font-size: 12px; font-weight: 700; text-transform: uppercase;">Tu Solvencia</p>
                    </div>
                </div>
                <div style="text-align: right;">
                    <h2 style="margin: 0; color: #64748b; font-size: 14px; text-transform: uppercase;">Comprobante de Pago</h2>
                    <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: 700; color: #1e293b;">N° <span id="inv_num"></span></p>
                    <p style="margin: 2px 0 0 0; font-size: 12px; color: #94a3b8;"><span id="inv_date"></span></p>
                </div>
            </div>
            <div style="background: #f8fafc; padding: 25px; border-radius: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; border: 1px solid #f1f5f9;">
                <div>
                    <h3 style="margin: 0 0 10px 0; font-size: 11px; text-transform: uppercase; color: #94a3b8;">Cliente</h3>
                    <p style="margin: 0; font-size: 16px; font-weight: 700;" id="inv_client_name"></p>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">CIP/Cédula: <span id="inv_client_cip"></span></p>
                </div>
                <div style="text-align: right;">
                    <span style="background: #dcfce7; color: #16a34a; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 800;">PAGO PROCESADO</span>
                </div>
            </div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                <thead>
                    <tr style="border-bottom: 2px solid #f1f5f9;">
                        <th style="padding: 15px 0; text-align: left; font-size: 12px; color: #94a3b8;">DESCRIPCIÓN</th>
                        <th style="padding: 15px 0; text-align: right; font-size: 12px; color: #94a3b8;">MONTO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 20px 0; border-bottom: 1px solid #f1f5f9; font-weight: 700;">Abono a Capital</td>
                        <td style="padding: 20px 0; text-align: right; border-bottom: 1px solid #f1f5f9; font-weight: 700;">$ <span id="inv_p_pri"></span></td>
                    </tr>
                    <tr>
                        <td style="padding: 20px 0; border-bottom: 1px solid #f1f5f9; font-weight: 700;">Intereses Cobrados</td>
                        <td style="padding: 20px 0; text-align: right; border-bottom: 1px solid #f1f5f9; font-weight: 700;">$ <span id="inv_p_int"></span></td>
                    </tr>
                </tbody>
            </table>
            <div style="display: flex; justify-content: flex-end;">
                <div style="width: 300px;">
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; font-size: 20px; font-weight: 800; border-top: 3px solid #1e293b;">
                        <span>TOTAL</span>
                        <span style="color: #16a34a;">$ <span id="inv_total"></span></span>
                    </div>
                    <div style="background: #fffbeb; border: 1px dashed #f59e0b; padding: 15px; margin-top: 20px; text-align: center; border-radius: 10px;">
                        <p style="margin: 0; font-size: 11px; color: #b45309; font-weight: 700;">SALDO PENDIENTE</p>
                        <p style="margin: 5px 0 0 0; font-size: 22px; font-weight: 800; color: #b45309;">$ <span id="inv_remaining"></span></p>
                    </div>
                </div>
            </div>
            <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; color: #94a3b8; font-size: 11px;">
                Gracias por su confianza. Este documento es un comprobante oficial de pago.
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO CON GESTIÓN DE USUARIOS ---
        let rawData = localStorage.getItem('puntocredito_v5');
        let state = rawData ? JSON.parse(rawData) : { 
            earnings: 0, 
            loans: [], 
            clientsDatabase: [], 
            investors: [], 
            paymentHistory: [],
            users: [{ user: 'admin', pass: '1234', role: 'admin', perms: { dashboard: true, clients: true, investors: true, config: true } }] // Usuario inicial
        };
        
        // Corregir estados antiguos sin tabla de usuarios
        if(!state.users) state.users = [{ user: 'admin', pass: '1234', role: 'admin', perms: { dashboard: true, clients: true, investors: true, config: true } }];

        function saveState() {
            localStorage.setItem('puntocredito_v5', JSON.stringify(state));
            renderDashboard(); renderClients(); renderInvestors(); renderUserList();
        }

        // --- LÓGICA DE LOGIN ---
        function checkLogin() {
            const u = document.getElementById('user_login').value;
            const p = document.getElementById('pass_login').value;
            const user = state.users.find(x => x.user === u && x.pass === p);
            if(user) {
                document.getElementById('login-overlay').style.display = 'none';
                sessionStorage.setItem('pc_logged', 'true');
                sessionStorage.setItem('pc_user', u);
                applyUserPermissions();
            } else { alert("Datos incorrectos"); }
        }

        function logout() { sessionStorage.removeItem('pc_logged'); sessionStorage.removeItem('pc_user'); location.reload(); }

        // Autologin si ya entró
        if(sessionStorage.getItem('pc_logged')) {
            document.getElementById('login-overlay').style.display = 'none';
            applyUserPermissions();
        }

        function createUser() {
            const u = document.getElementById('nu_name').value;
            const p = document.getElementById('nu_pass').value;
            if(!u || !p) return;
            const role = document.getElementById('nu_role') ? document.getElementById('nu_role').value : 'user';
            let perms = {
                dashboard: !!document.getElementById('nu_perm_dashboard').checked,
                clients: !!document.getElementById('nu_perm_clients').checked,
                investors: !!document.getElementById('nu_perm_investors').checked,
                config: !!document.getElementById('nu_perm_config').checked
            };
            if(role === 'admin') {
                perms = { dashboard: true, clients: true, investors: true, config: true };
            }
            state.users.push({ user: u, pass: p, role, perms });
            saveState();
            document.getElementById('nu_name').value = '';
            document.getElementById('nu_pass').value = '';
            document.getElementById('nu_perm_dashboard').checked = false;
            document.getElementById('nu_perm_clients').checked = false;
            document.getElementById('nu_perm_investors').checked = false;
            document.getElementById('nu_perm_config').checked = false;
            if(document.getElementById('nu_role')) document.getElementById('nu_role').value = 'user';
        }

        function renderUserList() {
            const list = document.getElementById('user_list_admin');
            list.innerHTML = '';
            state.users.forEach(u => {
                const allowed = [];
                if(u.perms && u.perms.dashboard) allowed.push('Dashboard');
                if(u.perms && u.perms.clients) allowed.push('Clientes');
                if(u.perms && u.perms.investors) allowed.push('Aportantes');
                if(u.perms && u.perms.config) allowed.push('Config');
                const roleLabel = u.role ? `<div class="text-[11px] text-slate-600">Rol: <span class="font-medium text-slate-700">${u.role}</span></div>` : '';
                list.innerHTML += `
                    <div class="py-2 text-xs border-b border-slate-100 pb-2 mb-2">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold">${u.user}</div>
                                ${roleLabel}
                                <div class="text-[11px] text-slate-500">Contraseña: <span class="font-medium text-slate-700">${u.pass}</span></div>
                                <div class="text-[11px] text-slate-400">Puede ver: <span class="font-medium text-slate-700">${allowed.join(', ') || 'Ninguno'}</span></div>
                            </div>
                            <div class="pl-4">
                                <button onclick="deleteUser('${u.user}')" class="text-red-500 font-bold">X</button>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function deleteUser(name) {
            const userToDelete = state.users.find(u => u.user === name);
            if(!userToDelete) return;
            if(userToDelete.role === 'admin') {
                const adminCount = state.users.filter(u => u.role === 'admin').length;
                if(adminCount <= 1) return alert('No puedes borrar al último administrador');
            }
            state.users = state.users.filter(u => u.user !== name);
            saveState();
        }

        // Aplicar permisos del usuario logueado a la UI (ocultar botones que no correspondan)
        function applyUserPermissions() {
            const currentUser = sessionStorage.getItem('pc_user');
            // por defecto mostrar todo
            document.querySelectorAll('#mainNav .nav-btn').forEach(b => b.style.display = 'flex');
            if(!currentUser) return;
            const user = state.users.find(x => x.user === currentUser);
            if(!user) return;
            const perms = user.perms || {};
            document.querySelectorAll('#mainNav .nav-btn').forEach(btn => {
                const section = btn.getAttribute('data-section');
                if(section && !perms[section] && user.role !== 'admin') btn.style.display = 'none';
                else btn.style.display = 'flex';
            });
            const lbl = document.getElementById('currentUserLabel');
            if(lbl) lbl.innerText = currentUser;
        }

        function openProfile() {
            const currentUser = sessionStorage.getItem('pc_user');
            if(!currentUser) return alert('No hay usuario activo');
            const user = state.users.find(x => x.user === currentUser);
            if(!user) return alert('Usuario no encontrado');
            document.getElementById('profile_user').innerText = user.user;
            document.getElementById('profile_pass').innerText = user.pass;
            document.getElementById('profile_role').innerText = user.role || 'user';
            const allowed = [];
            if(user.perms && user.perms.dashboard) allowed.push('Dashboard');
            if(user.perms && user.perms.clients) allowed.push('Clientes');
            if(user.perms && user.perms.investors) allowed.push('Aportantes');
            if(user.perms && user.perms.config) allowed.push('Configuración');
            document.getElementById('profile_allowed').innerText = allowed.join(', ') || 'Ninguno';
            document.getElementById('profileModal').classList.remove('hidden');
        }
        function closeProfile() { document.getElementById('profileModal').classList.add('hidden'); }

        // --- LAS FUNCIONES ORIGINALES SIGUEN ABAJO SIN CAMBIOS ---
        function showSection(id, btn) {
            // Verificar permisos antes de mostrar
            const currentUser = sessionStorage.getItem('pc_user');
            if(currentUser) {
                const user = state.users.find(x => x.user === currentUser);
                if(user && user.role !== 'admin') {
                    if(user && user.perms && !user.perms[id]) return alert('No tiene permiso para ver esta sección');
                }
            }
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('nav-btn-active');
                b.classList.add('text-slate-400', 'hover:bg-slate-800');
            });
            if(btn) btn.classList.add('nav-btn-active');
        }

        // --- LÓGICA APORTANTES ---
        function openInvestorModal() { document.getElementById('investorModal').classList.remove('hidden'); }
        function closeInvestorModal() { document.getElementById('investorModal').classList.add('hidden'); }
        function saveInvestor() {
            const name = document.getElementById('i_name').value;
            const amount = parseFloat(document.getElementById('i_amount').value);
            if(!name || isNaN(amount)) return;
            state.investors.push({ id: Date.now(), name, amount });
            saveState(); closeInvestorModal();
        }
        function addCapitalToInvestor(id) {
            const addValue = parseFloat(prompt("Monto a inyectar:"));
            if (isNaN(addValue) || addValue <= 0) return;
            const inv = state.investors.find(i => i.id === id);
            if (inv) { inv.amount += addValue; saveState(); }
        }
        function openEditInvestorModal(id) {
            const inv = state.investors.find(i => i.id === id);
            if (!inv) return;
            document.getElementById('ei_id').value = inv.id;
            document.getElementById('ei_name').value = inv.name;
            document.getElementById('ei_amount').value = inv.amount;
            document.getElementById('editInvestorModal').classList.remove('hidden');
        }
        function closeEditInvestorModal() { document.getElementById('editInvestorModal').classList.add('hidden'); }
        function updateInvestor() {
            const id = parseInt(document.getElementById('ei_id').value);
            const inv = state.investors.find(i => i.id === id);
            if (inv) {
                inv.name = document.getElementById('ei_name').value;
                inv.amount = parseFloat(document.getElementById('ei_amount').value);
                saveState(); closeEditInvestorModal();
            }
        }
        function deleteInvestor(id) {
            if (confirm("¿Eliminar aportante?")) {
                const numAportantes = state.investors.length;
                const shareOfEarnings = state.earnings / numAportantes;
                state.earnings -= shareOfEarnings; 
                state.investors = state.investors.filter(i => i.id !== id);
                saveState();
            }
        }
        function renderInvestors() {
            const grid = document.getElementById('investorsGrid'); grid.innerHTML = '';
            const numAportantes = state.investors.length;
            const gananciaPorPersona = numAportantes > 0 ? (state.earnings / numAportantes) : 0;
            state.investors.forEach(inv => {
                grid.innerHTML += `
                    <div class="bg-white p-6 rounded-3xl border shadow-sm relative">
                        <div class="flex justify-between items-start mb-4">
                            <div><h3 class="font-bold text-slate-800">${inv.name}</h3><p class="text-[10px] text-slate-400 font-bold uppercase">Socio</p></div>
                            <button onclick="addCapitalToInvestor(${inv.id})" class="bg-emerald-100 text-emerald-600 w-8 h-8 rounded-full hover:bg-emerald-600 hover:text-white transition-all"><i class="fas fa-plus text-xs"></i></button>
                        </div>
                        <div class="space-y-2 text-sm mb-4">
                            <div class="flex justify-between"><span>Capital:</span><span class="font-bold text-slate-700">$${inv.amount.toFixed(2)}</span></div>
                            <div class="flex justify-between"><span>Parte Ganancia:</span><span class="font-bold text-emerald-600">+$${gananciaPorPersona.toFixed(2)}</span></div>
                            <div class="border-t pt-2 flex justify-between font-bold"><span>Balance:</span><span>$${(inv.amount + gananciaPorPersona).toFixed(2)}</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="openEditInvestorModal(${inv.id})" class="bg-slate-100 text-slate-500 py-2 rounded-xl text-[10px] font-bold hover:bg-indigo-600 hover:text-white transition-all">EDITAR</button>
                            <button onclick="deleteInvestor(${inv.id})" class="bg-red-50 text-red-500 py-2 rounded-xl text-[10px] font-bold hover:bg-red-600 hover:text-white transition-all">ELIMINAR</button>
                        </div>
                    </div>`;
            });
        }

        // --- LÓGICA PRÉSTAMOS ---
        function openModal() {
            const select = document.getElementById('m_select_client');
            select.innerHTML = '<option value="">-- Nuevo Cliente --</option>';
            state.clientsDatabase.forEach(c => select.innerHTML += `<option value="${c.cip}">${c.name}</option>`);
            document.getElementById('loanModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('loanModal').classList.add('hidden'); }
        function fillClientData() {
            const cip = document.getElementById('m_select_client').value;
            const client = state.clientsDatabase.find(c => c.cip === cip);
            if(client) {
                document.getElementById('m_name').value = client.name;
                document.getElementById('m_cip').value = client.cip;
                document.getElementById('m_phone').value = client.phone || "";
            }
        }
        function saveLoan() {
            const amount = parseFloat(document.getElementById('m_amount').value);
            const name = document.getElementById('m_name').value;
            const cip = document.getElementById('m_cip').value;
            const interest = parseFloat(document.getElementById('m_interest').value);
            const totalAportado = state.investors.reduce((acc, inv) => acc + inv.amount, 0);
            const lentTotal = state.loans.reduce((acc, l) => acc + l.currentPrincipal, 0);
            if(amount > (totalAportado - lentTotal)) return alert("Fondos insuficientes.");
            let client = state.clientsDatabase.find(c => c.cip === cip);
            if(!client) {
                client = { name, cip, phone: document.getElementById('m_phone').value, loanCount: 1 };
                state.clientsDatabase.push(client);
            } else { client.loanCount = (client.loanCount || 0) + 1; }
            state.loans.push({ id: Date.now(), name, cip, currentPrincipal: amount, interestRate: interest, totalDebt: amount + (amount * (interest/100)) });
            saveState(); closeModal();
        }

        // --- LÓGICA DASHBOARD, COBROS Y FACTURA (INTEGRA FACTURA COMPLETA) ---
        function renderDashboard() {
            const tbody = document.getElementById('loanTableBody'); tbody.innerHTML = '';
            let lentTotal = 0;
            state.loans.forEach(l => {
                lentTotal += l.currentPrincipal;
                tbody.innerHTML += `
                    <tr>
                        <td class="p-4"><b>${l.name}</b><br><span class="text-[10px] text-slate-400 font-bold uppercase">${l.cip}</span></td>
                        <td class="p-4 font-bold">$${l.currentPrincipal.toFixed(2)}</td>
                        <td class="p-4 text-center text-slate-400">${l.interestRate}%</td>
                        <td class="p-4 text-right text-emerald-600 font-bold">$${(l.totalDebt - l.currentPrincipal).toFixed(2)}</td>
                        <td class="p-4 text-center"><button onclick="makeAbono(${l.id})" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg font-bold text-xs hover:bg-emerald-600 hover:text-white transition-all">COBRAR</button></td>
                    </tr>`;
            });
            const totalAportado = state.investors.reduce((acc, inv) => acc + inv.amount, 0);
            document.getElementById('statAvailable').innerText = `$${(totalAportado - lentTotal).toFixed(2)}`;
            document.getElementById('statLent').innerText = `$${lentTotal.toFixed(2)}`;
            document.getElementById('statTotalEarned').innerText = `$${state.earnings.toFixed(2)}`;
            document.getElementById('statActiveCount').innerText = state.loans.length;
            document.getElementById('sidebarTotal').innerText = `$${(totalAportado + state.earnings).toFixed(2)}`;
        }

        async function makeAbono(id) {
            const loan = state.loans.find(l => l.id === id);
            const abono = parseFloat(prompt(`Deuda total: $${loan.totalDebt.toFixed(2)}. Ingrese pago:`));
            if(isNaN(abono) || abono <= 0 || abono > (loan.totalDebt + 0.01)) return;
            const pInt = Math.min(abono, loan.totalDebt - loan.currentPrincipal);
            const pPri = abono - pInt;
            state.earnings += pInt;
            loan.currentPrincipal -= pPri;
            const remaining = Math.max(0, loan.currentPrincipal);
            state.paymentHistory.push({ cip: loan.cip, date: new Date().toLocaleString(), total: abono, pPri, pInt, remaining });
            const invNum = `REC-${Math.floor(Math.random()*900000)+100000}`;
            document.getElementById('inv_num').innerText = invNum;
            document.getElementById('inv_date').innerText = new Date().toLocaleString();
            document.getElementById('inv_client_name').innerText = loan.name;
            document.getElementById('inv_client_cip').innerText = loan.cip;
            document.getElementById('inv_p_pri').innerText = pPri.toFixed(2);
            document.getElementById('inv_p_int').innerText = pInt.toFixed(2);
            document.getElementById('inv_total').innerText = abono.toFixed(2);
            document.getElementById('inv_remaining').innerText = remaining.toFixed(2);
            const opt = { margin: 0, filename: `Comprobante_${loan.name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            const element = document.getElementById('invoice-template');
            // Preguntar si desea descargar el comprobante
            if(confirm('¿Desea descargar el comprobante de pago?')) {
                await html2pdf().set(opt).from(element).save();
            }
            if(loan.currentPrincipal < 0.1) state.loans = state.loans.filter(l => l.id !== id);
            else loan.totalDebt = loan.currentPrincipal + (loan.currentPrincipal * (loan.interestRate/100));
            saveState();
        }

        function renderClients() {
            const grid = document.getElementById('clientsGrid'); grid.innerHTML = '';
            state.clientsDatabase.forEach(c => {
                grid.innerHTML += `
                    <div class="bg-white p-6 rounded-3xl border shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div><h3 class="font-bold text-slate-800">${c.name}</h3><p class="text-xs text-slate-400">CIP: ${c.cip}</p></div>
                            <span class="bg-indigo-50 text-indigo-600 text-[10px] font-bold px-2 py-1 rounded-lg">Veces: ${c.loanCount || 0}</span>
                        </div>
                        <div class="space-y-2">
                            <button onclick="openEditClientModal('${c.cip}')" class="w-full bg-slate-100 text-slate-600 py-2 rounded-xl text-[10px] font-bold hover:bg-indigo-600 hover:text-white transition-all">MODIFICAR</button>
                            <button onclick="viewHistory('${c.cip}')" class="w-full bg-blue-50 text-blue-600 py-2 rounded-xl text-[10px] font-bold hover:bg-blue-600 hover:text-white transition-all">VER HISTORIAL</button>
                            <button onclick="deleteClient('${c.cip}')" class="w-full bg-red-50 text-red-600 py-2 rounded-xl text-[10px] font-bold hover:bg-red-600 hover:text-white transition-all">ELIMINAR CLIENTE</button>
                        </div>
                    </div>`;
            });
        }

        function viewHistory(cip) {
            const client = state.clientsDatabase.find(c => c.cip === cip);
            const history = state.paymentHistory.filter(h => h.cip === cip);
            document.getElementById('historyClientName').innerText = client ? client.name : "Cliente";
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = history.length ? '' : '<tr><td colspan="5" class="p-10 text-center text-slate-400">No hay pagos registrados.</td></tr>';
            history.reverse().forEach(h => {
                tbody.innerHTML += `<tr><td class="p-3 text-[11px]">${h.date}</td><td class="p-3 font-bold">$${h.total.toFixed(2)}</td><td class="p-3 text-slate-500">$${h.pPri.toFixed(2)}</td><td class="p-3 text-emerald-600">$${h.pInt.toFixed(2)}</td><td class="p-3 font-bold text-orange-600">$${h.remaining.toFixed(2)}</td></tr>`;
            });
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function downloadHistory() {
            const clientName = document.getElementById('historyClientName').innerText || 'cliente';
            const table = document.getElementById('historyTableBody').cloneNode(true);
            // Construir elemento temporal
            const wrap = document.createElement('div');
            wrap.style.padding = '20px';
            wrap.style.fontFamily = 'Segoe UI, Arial, sans-serif';
            wrap.style.color = '#334155';
            const title = document.createElement('h2');
            title.innerText = `Historial de pagos - ${clientName}`;
            title.style.marginBottom = '10px';
            wrap.appendChild(title);
            const tbl = document.createElement('table');
            tbl.style.width = '100%';
            tbl.style.borderCollapse = 'collapse';
            tbl.innerHTML = `
                <thead>
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <th style="padding:8px;text-align:left">Fecha</th>
                        <th style="padding:8px;text-align:right">Abono Total</th>
                        <th style="padding:8px;text-align:right">A Capital</th>
                        <th style="padding:8px;text-align:right">Interés</th>
                        <th style="padding:8px;text-align:right">Saldo Rest.</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbodyNew = tbl.querySelector('tbody');
            // copiar filas
            Array.from(table.querySelectorAll('tr')).forEach(r => tbodyNew.appendChild(r.cloneNode(true)));
            wrap.appendChild(tbl);
            document.getElementById('invoice-container').appendChild(wrap);
            const opt = { margin: 0.4, filename: `Historial_${clientName}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            html2pdf().set(opt).from(wrap).save().then(()=> wrap.remove()).catch(()=> wrap.remove());
        }

        function closeHistoryModal() { document.getElementById('historyModal').classList.add('hidden'); }
        function resetEarnings() { if(confirm("¿Reiniciar intereses?")) { state.earnings = 0; saveState(); } }
        function resetApp() { if(confirm("¿Reiniciar sistema completo?")) { localStorage.clear(); location.reload(); } }
        
        // Iniciar
        saveState();
    </script>
</body>
</html>